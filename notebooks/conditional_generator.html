<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Generate a feasible design from an array of latent weights">

<title>Inverse Design - Conditional Generator</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Inverse Design - Conditional Generator">
<meta property="og:description" content="Generate a feasible design from an array of latent weights">
<meta property="og:site-name" content="Inverse Design">
<meta name="twitter:title" content="Inverse Design - Conditional Generator">
<meta name="twitter:description" content="Generate a feasible design from an array of latent weights">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Inverse Design</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Conditional Generator</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Inverse Design</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">notebooks</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/utils.html" class="sidebar-item-text sidebar-link">Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/brushes.html" class="sidebar-item-text sidebar-link">Brushes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/design.html" class="sidebar-item-text sidebar-link">Design</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/conditional_generator.html" class="sidebar-item-text sidebar-link active">Conditional Generator</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/direct_optimization.html" class="sidebar-item-text sidebar-link">Direct Optimization</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/naive_inverse_design.html" class="sidebar-item-text sidebar-link">Naive Inverse Design</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/inverse_design.html" class="sidebar-item-text sidebar-link">Inverse Design</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/naive_generator.html" class="sidebar-item-text sidebar-link">Naive Generator</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/local_generator.html" class="sidebar-item-text sidebar-link">Local Generator</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/inverse_design_local.html" class="sidebar-item-text sidebar-link">Inverse Design Local</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/ceviche_challenges.html" class="sidebar-item-text sidebar-link">Ceviche Challenges</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#latent-design" id="toc-latent-design" class="nav-link active" data-scroll-target="#latent-design">Latent Design</a>
  <ul class="collapse">
  <li><a href="#new_latent_design" id="toc-new_latent_design" class="nav-link" data-scroll-target="#new_latent_design">new_latent_design</a></li>
  </ul></li>
  <li><a href="#transform" id="toc-transform" class="nav-link" data-scroll-target="#transform">Transform</a>
  <ul class="collapse">
  <li><a href="#transform-1" id="toc-transform-1" class="nav-link" data-scroll-target="#transform-1">transform</a></li>
  </ul></li>
  <li><a href="#conditional-generator" id="toc-conditional-generator" class="nav-link" data-scroll-target="#conditional-generator">Conditional Generator</a>
  <ul class="collapse">
  <li><a href="#conditional_algirithm_step" id="toc-conditional_algirithm_step" class="nav-link" data-scroll-target="#conditional_algirithm_step">conditional_algirithm_step</a></li>
  <li><a href="#conditional_generator" id="toc-conditional_generator" class="nav-link" data-scroll-target="#conditional_generator">conditional_generator</a></li>
  <li><a href="#generate_feasible_design" id="toc-generate_feasible_design" class="nav-link" data-scroll-target="#generate_feasible_design">generate_feasible_design</a></li>
  <li><a href="#generate_feasible_design_mask_" id="toc-generate_feasible_design_mask_" class="nav-link" data-scroll-target="#generate_feasible_design_mask_">generate_feasible_design_mask_</a></li>
  </ul></li>
  <li><a href="#straight-through-estimator" id="toc-straight-through-estimator" class="nav-link" data-scroll-target="#straight-through-estimator">Straight Through Estimator</a>
  <ul class="collapse">
  <li><a href="#generate_feasible_design_mask" id="toc-generate_feasible_design_mask" class="nav-link" data-scroll-target="#generate_feasible_design_mask">generate_feasible_design_mask</a></li>
  <li><a href="#generate_feasible_design_mask_jvp" id="toc-generate_feasible_design_mask_jvp" class="nav-link" data-scroll-target="#generate_feasible_design_mask_jvp">generate_feasible_design_mask_jvp</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/flaport/inverse_design/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Conditional Generator</h1>
</div>

<div>
  <div class="description">
    Generate a feasible design from an array of latent weights
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:21.150313Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:21.150052Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:21.769361Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:21.768786Z&quot;}" data-papermill="{&quot;duration&quot;:0.6263,&quot;end_time&quot;:&quot;2023-02-08T05:20:21.770993&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:21.144693&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>my_brush <span class="op">=</span> circular_brush(<span class="dv">7</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>my_brush <span class="op">=</span> notched_square_brush(<span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>show_mask(my_brush)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_conditional_generator_files/figure-html/cell-3-output-2.png" class="img-fluid"></p>
</div>
</div>
<section id="latent-design" class="level2">
<h2 class="anchored" data-anchor-id="latent-design">Latent Design</h2>
<p>It’s not very well explained in the paper what the latent design actually is. In this case we’ll just assume it’s an array of the same shape as the design, but with continuous values between 0 and 1.</p>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/conditional_generator.py#L29" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="new_latent_design" class="level3">
<h3 class="anchored" data-anchor-id="new_latent_design">new_latent_design</h3>
<blockquote class="blockquote">
<pre><code> new_latent_design (shape, bias=0, r=None, r_scale=1)</code></pre>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:21.808833Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:21.808553Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:22.049490Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:22.048894Z&quot;}" data-papermill="{&quot;duration&quot;:0.248546,&quot;end_time&quot;:&quot;2023-02-08T05:20:22.051298&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:21.802752&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>m,n <span class="op">=</span> <span class="dv">30</span>, <span class="dv">30</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>latent <span class="op">=</span> new_latent_design((m,n), r<span class="op">=</span>seed)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(latent[:<span class="dv">3</span>, :<span class="dv">3</span>])</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>plt.imshow(latent, vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, cmap<span class="op">=</span><span class="st">"Greys"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 0.49671414 -0.1382643   0.64768857]
 [-0.6017066   1.8522782  -0.01349723]
 [-0.47917423 -0.18565898 -1.1063349 ]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_conditional_generator_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:22.099798Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:22.099518Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:22.102493Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:22.101938Z&quot;}" data-papermill="{&quot;duration&quot;:0.011549,&quot;end_time&quot;:&quot;2023-02-08T05:20:22.104987&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:22.093438&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#with open(f"latent{seed}_{m}x{n}.bin", "wb") as file:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    file.write(latent.tobytes())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="transform" class="level2">
<h2 class="anchored" data-anchor-id="transform">Transform</h2>
<p>The transform removes some of the noise from the latent design.</p>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/conditional_generator.py#L36" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="transform-1" class="level3">
<h3 class="anchored" data-anchor-id="transform-1">transform</h3>
<blockquote class="blockquote">
<pre><code> transform (latent, brush, beta=5.0)</code></pre>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:22.143566Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:22.143298Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:22.468966Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:22.468047Z&quot;}" data-papermill="{&quot;duration&quot;:0.333467,&quot;end_time&quot;:&quot;2023-02-08T05:20:22.470831&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:22.137364&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>latent_t <span class="op">=</span> transform(latent, my_brush)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(latent_t[:<span class="dv">3</span>, :<span class="dv">3</span>])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(latent_t, cmap<span class="op">=</span><span class="st">"Greys"</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 0.3590585   0.21954855  0.19020812]
 [ 0.35060647  0.0249535   0.25184518]
 [ 0.01658658 -0.10942358 -0.0914182 ]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_conditional_generator_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="conditional-generator" class="level2">
<h2 class="anchored" data-anchor-id="conditional-generator">Conditional Generator</h2>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/conditional_generator.py#L41" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="conditional_algirithm_step" class="level3">
<h3 class="anchored" data-anchor-id="conditional_algirithm_step">conditional_algirithm_step</h3>
<blockquote class="blockquote">
<pre><code> conditional_algirithm_step (latent_t, design, brush, verbose=False)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/conditional_generator.py#L110" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="conditional_generator" class="level3">
<h3 class="anchored" data-anchor-id="conditional_generator">conditional_generator</h3>
<blockquote class="blockquote">
<pre><code> conditional_generator (latent_t, brush, verbose=False)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/local_generator.py#L423" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_feasible_design" class="level3">
<h3 class="anchored" data-anchor-id="generate_feasible_design">generate_feasible_design</h3>
<blockquote class="blockquote">
<pre><code> generate_feasible_design (latent_t, brush, verbose=False, backend='auto')</code></pre>
</blockquote>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>latent_t</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>brush</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>verbose</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr class="even">
<td>backend</td>
<td>str</td>
<td>auto</td>
<td>backend: ‘auto’, ‘rust’, ‘python’</td>
</tr>
</tbody>
</table>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:22.574058Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:22.573715Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:25.349526Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:25.348809Z&quot;}" data-papermill="{&quot;duration&quot;:2.784313,&quot;end_time&quot;:&quot;2023-02-08T05:20:25.351625&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:22.567312&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>my_design</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 10.4 ms, sys: 3.89 ms, total: 14.3 ms
Wall time: 12.8 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">

</div>
<div class="cell-output cell-output-display">
<p><img src="04_conditional_generator_files/figure-html/cell-12-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:25.366449Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:25.366063Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:25.560955Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:25.560203Z&quot;}" data-papermill="{&quot;duration&quot;:0.20425,&quot;end_time&quot;:&quot;2023-02-08T05:20:25.562557&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:25.358307&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>latent_t <span class="op">=</span> transform(latent, my_brush)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>plt.imshow(latent_t, cmap<span class="op">=</span><span class="st">"Greys"</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="04_conditional_generator_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>In practice however, it’s probably more useful to generate a design <em>mask</em> straight away (+1.0 for solid, -1.0 for void):</p>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/conditional_generator.py#L177" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_feasible_design_mask_" class="level3">
<h3 class="anchored" data-anchor-id="generate_feasible_design_mask_">generate_feasible_design_mask_</h3>
<blockquote class="blockquote">
<pre><code> generate_feasible_design_mask_ (latent_t, brush, backend='auto')</code></pre>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:25.614125Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:25.613735Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:25.693170Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:25.692389Z&quot;}" data-papermill="{&quot;duration&quot;:0.089428,&quot;end_time&quot;:&quot;2023-02-08T05:20:25.694884&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:25.605456&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>my_design_mask <span class="op">=</span> generate_feasible_design_mask_(latent_t, my_brush)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>my_design_mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>(30, 30)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:25.711021Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:25.710636Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:25.893447Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:25.892684Z&quot;}" data-papermill="{&quot;duration&quot;:0.193576,&quot;end_time&quot;:&quot;2023-02-08T05:20:25.895689&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:25.702113&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(my_design_mask, cmap<span class="op">=</span><span class="st">"Greys"</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="04_conditional_generator_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="straight-through-estimator" class="level2">
<h2 class="anchored" data-anchor-id="straight-through-estimator">Straight Through Estimator</h2>
<p>We cannot just call <code>jax.grad</code> on our feasible design mask generator. All gradients will be zero as our mask generator is not differentiable…</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:25.942541Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:25.942070Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:25.946022Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:25.945341Z&quot;}" data-papermill="{&quot;duration&quot;:0.013957,&quot;end_time&quot;:&quot;2023-02-08T05:20:25.947765&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:25.933808&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_test_loss_function_(latent_t, brush):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> generate_feasible_design_mask_(latent_t, brush, backend<span class="op">=</span><span class="st">'python'</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:25.964172Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:25.963826Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:32.278087Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:32.277480Z&quot;}" data-papermill="{&quot;duration&quot;:6.324216,&quot;end_time&quot;:&quot;2023-02-08T05:20:32.279831&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:25.955615&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> jax.grad(my_test_loss_function_)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> (g(latent_t, my_brush) <span class="op">==</span> <span class="dv">0</span>).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, if we would have chosen the Rust-based backend, the above cell would have errored out…</p>
<p>In stead, we use a straight-through estimator (a.k.a. identity function) for our feasible design:</p>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/local_generator.py#L450" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="generate_feasible_design_mask" class="level3">
<h3 class="anchored" data-anchor-id="generate_feasible_design_mask">generate_feasible_design_mask</h3>
<blockquote class="blockquote">
<pre><code> generate_feasible_design_mask (latent_t, brush)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/flaport/inverse_design/blob/master/inverse_design/local_generator.py#L468" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_feasible_design_mask_jvp" class="level3">
<h3 class="anchored" data-anchor-id="generate_feasible_design_mask_jvp">generate_feasible_design_mask_jvp</h3>
<blockquote class="blockquote">
<pre><code> generate_feasible_design_mask_jvp (primals, tangents)</code></pre>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:32.355087Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:32.354641Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:32.357867Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:32.357358Z&quot;}" data-papermill="{&quot;duration&quot;:0.013303,&quot;end_time&quot;:&quot;2023-02-08T05:20:32.359194&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:32.345891&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_test_loss_function(latent_t, brush):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> generate_feasible_design_mask(latent_t, brush).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-02-08T05:20:32.375846Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-02-08T05:20:32.375332Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-02-08T05:20:32.453090Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-02-08T05:20:32.452396Z&quot;}" data-papermill="{&quot;duration&quot;:0.088222,&quot;end_time&quot;:&quot;2023-02-08T05:20:32.455001&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-02-08T05:20:32.366779&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> jax.grad(my_test_loss_function)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> (g(latent_t, my_brush) <span class="op">!=</span> <span class="dv">0</span>).<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>